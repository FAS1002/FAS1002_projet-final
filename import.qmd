---
title: "Importation"
title-block-banner: true
description: | 
  Cette page regroupe la première importation des données à l'état brute ainsi que les manipulation de bases.
# à changer
date: "2022-12-21"
# Modifier les détails que vous voulez
author:
  - name: "Juliette Leblanc"
    # Votre site web perso ou github
    url: https://github.com/JulLeblanc
    # les champs d'affiliation sont optionnels, vous pouvez les
    # comment out en ajoutant un # devant.
    affiliation: FAS1002
    affiliation-url: https://FAS1002.github.io/A22
    # changer pour votre propre orcid id
    # https://orcid.org/ pour vous inscrire.
    # orcid: 0000-0000-0000-0000

# TRUE == Générer une citation pour cette page précise. Pour enlever, mettre false.
citation: true
# Inclure les références que vous utilisez dans vos rapports. Je conseille Zotero pour construire
# ce fichier ou de connecter RStudio directement pour pouvoir citer avec @nom-de-reference.
bibliography: references.bib
---

```{r echo=FALSE, warning=FALSE, message=FALSE}
library(fs)
library(lubridate)
library(tidyverse)
library(readr)
library(skimr)
library(cronR)
library(readr)
library(readxl)
library(RCurl)
library(googlesheets4)
library(gsheet)
library(countrycode)
```

# Introduction

Le présent projet travaille avec deux bases de données : La première est issue de Our World in Data, un site qui publie gratuitement des bases de données et de la recherche sur les enjeux contemporains que le monde traverse (économie, écologie, climat, énergie, conflits etc).\
La deuxième base de donnée est issue de Gapminder, une OBNL suèdoise, qui propose en libre accès d'importantes bases de données aussi sur les enjeux actuels, dans le but de prévenir et lutter contre la mésinformation.

# Importation quotidienne

## Jeu de données CO2 _Our World in Data_

La base de donnée _CO2 & Greenhouse Gas Emissions_ est utilisée. Elle permet de faire différentes explorations statistiques sur les émissions de CO2 dans 207 pays depuis le 19ème siècle.

Ajouter lien web 

```{r download co2, cache=TRUE, warning=FALSE, error=FALSE, show_col_types=FALSE}

#Données CO2 d'OWID

urlowid = "https://raw.githubusercontent.com/owid/co2-data/master/owid-co2-data.csv"
basepath =  path("data", "raw") 
fnameowid = paste(today(), "owid-co2-data.csv", sep = "_") 
fpathowid = path(basepath, fnameowid) 
dataowid = download.file(url = urlowid, destfile = fpathowid)

dat_owid = read_csv(fpathowid)

#Automatisation du script

if (!file.exists(fpathowid)) {
    file.remove(junk)
    download.file(url = urlowid,
                  destfile = fpathowid,
                  show_col_types = FALSE)
    paste("Le fichier",
          fpathowid,
          "n'existait pas, il a donc été téléchargé à l'instant.")
  } else {
    print(paste("Le fichier",
                fpathowid,
                "existe déjà, il ne sera pas téléchargé à nouveau.")
) }

```

## Jeu de données _Gapminder_

La base de données "Life Expectancy at Birth" est utilisée. Elle permet aussi de faire des analyses statistiques sur la question de l'espérance de vie depuis le 19ème siècle. L'espérance de vie est aujourd'hui un des meilleurs indicateurs de développement d'un pays ainsi qu'une solide mesure de projection économique et démographique.Cette base de données contient au total 1505 observations

```{r download lifeexpectancy, cache=TRUE, warning=FALSE, error=FALSE}
#Données gapminder
library(gsheet)

#Utilisation de la fonction gsheet2tbl du package gsheet qui permet de convertir facilement une sheet google en dataframe

urlgapminder =  gsheet2tbl("https://docs.google.com/spreadsheets/d/1RheSon1-q4vFc3AGyupVPH6ptEByE-VtnjOCselU0PE/edit#gid=176703676")

#incorporation dans data/raw
basepathgm = path("data", "raw")

fnamegm = paste(today(), "gapm.csv", sep = "_")

fpathgm = path(basepathgm, fnamegm)

write_csv(x = urlgapminder, file = fpathgm)

datgm = read_csv(fpathgm)

#Automatisation du script, fréquence de téléchargement mensuelle

if (!file.exists(fpathgm)) {
    file.remove(junk)
    download.file(url = url,
                  destfile = fpathowid)
    paste("Le fichier",
          fpathowid,
          "n'existait pas, il a donc été téléchargé à l'instant.")
  } else {
    print(paste("Le fichier",
                fpathowid,
                "existe déjà, il ne sera pas téléchargé à nouveau.")
) }
```

# Manipulation des données

## Données CO2

La base de données CO2 contient 46.523 observations regroupé en 74 variables. Cette base de données propose de mieux comprendre les sources d'énergies dans 207 pays.Pour obtenir une meilleure lecture et analyse des données, il est apparu plus simple de traiter la base de données CO2 avec quelques variables et non dans sa totalité. Au total, 18 sur 74 variables ont été sélectionnées.

Pour mieux comprendre les variables, le tableau suivant propose le codebook suivant, adapté du [codebook original](https://github.com/owid/co2-data/blob/master/owid-co2-codebook.csv) .

| Variable              | Description + Type                                                                                                                                                                                                                                        |
|----------------|--------------------------------------------------------|
| Country               | pays (character)                                                                                                                                                                                                                                          |
| Year                  | année de l'observation (numérique)                                                                                                                                                                                                                        |
| Iso_code              | code du pays selon la codification internationale 3166-1 (character)                                                                                                                                                                                      |
| Population            | Nombre total de la population selon le pays (numérique)                                                                                                                                                                                                   |
| GDP (PIB)             | Produit interieur brut mesuré en dollars (numérique)                                                                                                                                                                                                      |
| CO2                   | Mesure annuelle de la production totale de CO2 par pays, mesuré en en millions de tonnes et excluant l'[UTCATF](https://fr.wikipedia.org/wiki/Utilisation_des_terres,_changement_d'affectation_des_terres_et_foresterie) (numérique)                      |
| Cement_CO2_per_capita | Mesure annuelle de la production totale de CO2 générée par le ciment, par personne, en millions de tonnes (numérique)                                                                                                                                     |
| CO2_per_gdp           | Mesure annuelle de la production totale de CO2 selon le PIB, excluant l'UTCATF (numérique)                                                                                                                                                                |
| coal_co2              | Mesure annuelle par pays de la production de CO2 générée par le charbon, en millions de tonnes (numérique)                                                                                                                                                |
| coal_co2_per_capita   | Mesure annuelle de la production de CO2 générée par le charbon, mesurée en million de tonnes par personnes (numérique)                                                                                                                                    |
| methane               | Total annuel des émissions de méthane par pays, incluant l'UTCATF, mesuré en millions de tonnes (numérique)                                                                                                                                               |
| methane_per_capita    | Total annuel des émissions de méthane par habitant, incluant l'UTCATF, mesuré en millions de tonnes (numérique)                                                                                                                                           |
| oil_co2               | Mesure annuelle par pays de la production de CO2 générée par le pétrole, en millions de tonnes (numérique)                                                                                                                                                |
| oil_co2_per_capita    | Mesure annuelle de la production de CO2 générée par le pétrole, mesurée en million de tonnes par personnes (numérique)                                                                                                                                    |
| ghg_per_capita        | Total des émissions de gas à effet de serres par personne, mesuré en tonne de de millions, incluant l'UTCATF (numérique)                                                                                                                                  |
| trade_co2             | Total annuel des émissions de C02, issu du commerce, mesuré en million de tonne. (Ici une valeur positive veut dire qu'un pays est un importeur net d'émission de CO2 ; une valeur négative veut dire qu'un pays est un exporteur net d'émission de CO2). |

```{r lecture et assemblage des données, warning=FALSE, message=FALSE, error=FALSE}
#Transformation des données en tibble

as.tibble(dat_owid)

#Filtrage du tibble

dat_CO2 = dat_owid %>% 

    select(country, year, iso_code, population, gdp, co2, cement_co2_per_capita, 

           co2_per_gdp, coal_co2, coal_co2_per_capita, gas_co2, gas_co2_per_capita,

           methane, methane_per_capita, oil_co2, oil_co2_per_capita, ghg_per_capita, trade_co2)

```

## Classement par continent

Dans les deux banques de données que nous utilisons, j'ai créé une variable qui regroupe les différents pays en sous-groupe des 5 continents soit : l'Afrique, l'Amérique, l'Asie, l'Europe et l'Océanie. Ceci me permettra de faire des comparaisons plus large en me référant au continent et non au pays.

```{r variable for continents, warning=FALSE, error=FALSE}

dat_CO2 <-  dat_CO2 %>% 
    mutate(continent = countrycode(sourcevar = dat_owid$country,
                                   origin = "country.name",
                                   destination = "continent"))
datgm <-  datgm %>%
    mutate(continent = countrycode(sourcevar = datgm$name,
                                   origin = "country.name",
                                   destination = "continent"))
```

## Temps écoulé

Il est également intéressant de voir le temps écoulé entre la production de se rapport et la première année que des données ont été récoltées pour chacun des pays qui se trouvent dans le jeu de données de *Life Expectancy at Birth*.

Cette variable prendra le nom de `time` dans la banque de données.

```{r}
# datgm <- datgm |> 
#     mutate(time_since = time) 
# 
# 
# as.Date, format = "%Y")
# 
# 
# 
#  as.numeric(difftime(as.POSIXct(today()),
#                      as.POSIXct(as.Date(min(LifeExDate$time_since), format = "%Y-%m-%d"))))

```


# Recoder certaines variables

Dans les banques de données que nous utilisons, des variables qui regroupent le même type d'information n'ont pas nécessairement le même nom.

Notamment, dans la banque de données r par uniformiser ceci, notamment en renommant les colonnes des pays pour `country`et pour l'année `year`.

```{r recode variables, warning=FALSE, error=FALSE}
datgm <- datgm |> 
    rename(country = name,
           year = time,
           life_exp = `Life expectancy`)
```



# Joindre les banques de données
```{r joindre les banques de données, warning=FALSE, error=FALSE, message=FALSE}
datultimate = inner_join(dat_CO2, datgm)
```


# Exporter

Maintenant qu'une première manipulation des données a été fait, nous pouvons exporter celles-ci comme étant des données traitées dans le dossier `data/processed`.

Les prochaines analyses auront comme point de départ les données traitées, donc qui ont été exportées dans le chemin relatif ci-dessus.

```{r exporting data to processed, warning=FALSE, error=FALSE}
write_csv(dat_CO2,file = "data/processed/dat_CO2.csv")

write_csv(datgm, file = "data/processed/datgm.csv")

write_csv(datultimate, file = "data/processed/datultimate.csv")
```
